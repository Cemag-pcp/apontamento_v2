{% extends "base.html" %}
{% load static %}

{% block title %}
<title>Apontamentos Innovaro</title>
{% endblock %}

{% block links %}
<style>
  .tab-pane { padding-top: 1rem; }
  table th, table td { vertical-align: middle; }
  .obs-input { min-width: 200px; }
  .nowrap { white-space: nowrap; }
  .small-muted { font-size: .85rem; color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">Apontamentos e Transferências</h2>
    <div class="small-muted">Consome {% url 'corte:apontamento_innovaro' %} e {% url 'corte:transferencia_innovaro' %}</div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted">Apontamentos pendentes</div>
              <div id="count-apontamentos" class="fs-3 fw-bold">-</div>
            </div>
            <div class="text-primary fs-2"><i class="bi bi-check2-square"></i></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted">Transferências pendentes</div>
              <div id="count-transferencias" class="fs-3 fw-bold">-</div>
            </div>
            <div class="text-primary fs-2"><i class="bi bi-box-arrow-right"></i></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="innovaroTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-apontamentos-tab" data-bs-toggle="tab" data-bs-target="#tab-apontamentos" type="button" role="tab" aria-controls="tab-apontamentos" aria-selected="true">Apontamentos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-transferencias-tab" data-bs-toggle="tab" data-bs-target="#tab-transferencias" type="button" role="tab" aria-controls="tab-transferencias" aria-selected="false">Transferências</button>
    </li>
  </ul>

  <div class="tab-content" id="innovaroTabsContent">
    <div class="tab-pane fade show active" id="tab-apontamentos" role="tabpanel" aria-labelledby="tab-apontamentos-tab">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="m-0">Pendentes de Apontar</h5>
        <div class="d-flex gap-2">
          <button id="bulk-apontar" class="btn btn-sm btn-success"><i class="bi bi-check2-all"></i> Apontar selecionados</button>
          <button id="refresh-apontamentos" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-repeat"></i> Atualizar</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm align-middle" id="table-apontamentos">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width:28px"><input type="checkbox" id="sel-all-apontamentos"></th>
              <th class="nowrap">Ordem</th>
              <th>Peça</th>
              <th class="text-end">Qt Planejada</th>
              <th class="text-end">Qt Produzida</th>
              <th class="text-end">Mortas</th>
              <th>Espessura</th>
              <th>Tamanho</th>
              <th class="text-end">Qt Chapas</th>
              <th class="text-end">Aproveitamento</th>
              <th>Operador</th>
              <th>Observação</th>
              <th class="text-center">Ação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-transferencias" role="tabpanel" aria-labelledby="tab-transferencias-tab">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="m-0">Pendentes de Transferir</h5>
        <div class="d-flex gap-2">
          <button id="bulk-transferir" class="btn btn-sm btn-primary"><i class="bi bi-box-arrow-in-right"></i> Transferir selecionados</button>
          <button id="refresh-transferencias" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-repeat"></i> Atualizar</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm align-middle" id="table-transferencias">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width:28px"><input type="checkbox" id="sel-all-transferencias"></th>
              <th class="nowrap">Ordem</th>
              <th>Matéria‑Prima</th>
              <th>Tamanho</th>
              <th>Espessura</th>
              <th class="text-end">Qt Chapas</th>
              <th class="text-end">Aproveitamento</th>
              <th>Tipo Chapa</th>
              <th>Retalho</th>
              <th>Data Finalização</th>
              <th>Observação</th>
              <th class="text-center">Ação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const URL_APONTAMENTOS = "{% url 'corte:apontamento_innovaro' %}"; // GET ?apontado=false
  const URL_TRANSFERENCIAS = "{% url 'corte:transferencia_innovaro' %}"; // GET ?apontado=false
  const URL_APONTAMENTOS_CONFIRMAR = "{% url 'corte:apontamento_innovaro_confirmar' %}"; // POST
  const URL_TRANSFERENCIAS_CONFIRMAR = "{% url 'corte:transferencia_innovaro_confirmar' %}"; // POST
  const URL_APONTAMENTOS_BULK = "{% url 'corte:apontamento_innovaro_bulk_confirmar' %}"; // POST
  const URL_TRANSFERENCIAS_BULK = "{% url 'corte:transferencia_innovaro_bulk_confirmar' %}"; // POST

  const csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

  function fmt(value) { return value == null ? '-' : value; }
  function fmtNum(n) { return (n == null || isNaN(n)) ? '-' : Number(n).toLocaleString('pt-BR'); }
  function setCount(id, n) {
    const el = document.getElementById(id);
    if (el) el.textContent = (typeof n === 'number') ? n.toLocaleString('pt-BR') : '-';
  }
  function decCount(id, delta=1) {
    const el = document.getElementById(id);
    if (!el) return;
    const curr = parseInt((el.textContent || '').replace(/\D/g,'')) || 0;
    const next = Math.max(0, curr - delta);
    el.textContent = next.toLocaleString('pt-BR');
  }

  async function fetchJson(url) {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Erro ao buscar dados: ' + res.status);
    return res.json();
  }

  function rowApontamento(a) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center"><input type="checkbox" class="row-select" data-numero-ordem="${fmt(a.numero_ordem)}" data-codigo-peca="${fmt(a.codigo_peca)}"></td>
      <td class="nowrap">${fmt(a.numero_ordem)}</td>
      <td>${fmt(a.codigo_peca)}</td>
      <td class="text-end">${fmtNum(a.qt_planejada)}</td>
      <td class="text-end">${fmtNum(a.qt_produzida)}</td>
      <td class="text-end">${fmtNum(a.mortas)}</td>
      <td>${fmt(a.espessura)}</td>
      <td>${fmt(a.tamanho_chapa)}</td>
      <td class="text-end">${fmtNum(a.qt_chapa)}</td>
      <td class="text-end">${fmtNum(a.aproveitamento)}</td>
      <td>${fmt(a.operador)}</td>
      <td><input class="form-control form-control-sm obs-input" type="text" placeholder="Observação" /></td>
      <td class="text-center">
        <button class="btn btn-sm btn-success btn-apontar"><i class="bi bi-check2-circle"></i> Apontado</button>
      </td>`;
    return tr;
  }

  function rowTransferencia(t) {
    const tr = document.createElement('tr');
    const dataFinal = t.data_finalizacao ? new Date(t.data_finalizacao).toLocaleString('pt-BR') : '-';
    tr.innerHTML = `
      <td class="text-center"><input type="checkbox" class="row-select" data-numero-ordem="${fmt(t.numero_ordem)}"></td>
      <td class="nowrap">${fmt(t.numero_ordem)}</td>
      <td>${fmt(t.mat_prima)}</td>
      <td>${fmt(t.tamanho)}</td>
      <td>${fmt(t.espessura)}</td>
      <td class="text-end">${fmtNum(t.qtd_chapa)}</td>
      <td class="text-end">${fmtNum(t.aproveitamento)}</td>
      <td>${fmt(t.tipo_chapa)}</td>
      <td>${fmt(t.retalho)}</td>
      <td>${dataFinal}</td>
      <td><input class="form-control form-control-sm obs-input" type="text" placeholder="Observação" /></td>
      <td class="text-center">
        <button class="btn btn-sm btn-primary btn-transferir"><i class="bi bi-box-arrow-right"></i> Transferir</button>
      </td>`;
    return tr;
  }

  function getColspan(tableSelector) {
    const theadCount = document.querySelector(`${tableSelector} thead tr`)?.children?.length || 1;
    return theadCount;
  }

  async function loadApontamentos() {
    const tbody = document.querySelector('#table-apontamentos tbody');
    tbody.innerHTML = `<tr><td colspan="${getColspan('#table-apontamentos')}" class="text-center small-muted py-3">Carregando...</td></tr>`;
    try {
      const data = await fetchJson(`${URL_APONTAMENTOS}?apontado=false`);
      const items = data.apontamentos || [];
      tbody.innerHTML = '';
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="${getColspan('#table-apontamentos')}" class="text-center small-muted py-3">Nenhum registro pendente.</td></tr>`;
      }
      items.forEach(a => tbody.appendChild(rowApontamento(a)));
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="12" class="text-center text-danger py-3">${e.message}</td></tr>`;
    }
  }

  async function loadTransferencias() {
    const tbody = document.querySelector('#table-transferencias tbody');
    tbody.innerHTML = `<tr><td colspan="${getColspan('#table-transferencias')}" class="text-center small-muted py-3">Carregando...</td></tr>`;
    try {
      const data = await fetchJson(`${URL_TRANSFERENCIAS}?apontado=false`);
      const items = data.transferencias || [];
      tbody.innerHTML = '';
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="${getColspan('#table-transferencias')}" class="text-center small-muted py-3">Nenhum registro pendente.</td></tr>`;
      }
      items.forEach(t => tbody.appendChild(rowTransferencia(t)));
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="11" class="text-center text-danger py-3">${e.message}</td></tr>`;
    }
  }

  // Confirmação e tentativa de envio (POST) — backend de atualização deve ser implementado
  async function confirmarAcao(titulo, texto, payload, postUrl) {
    const result = await Swal.fire({
      title: titulo,
      text: texto,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Confirmar',
      cancelButtonText: 'Cancelar'
    });
    if (!result.isConfirmed) return { ok: false };

    try {
      const res = await fetch(postUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        throw new Error('A API de atualização não está disponível (' + res.status + ').');
      }
      return { ok: true };
    } catch (err) {
      await Swal.fire({ icon: 'warning', title: 'Não atualizado', text: err.message });
      return { ok: false };
    }
  }

  function removeRowAndMaybeEmpty(tr, tableSelector) {
    const tbody = document.querySelector(`${tableSelector} tbody`);
    tr.remove();
    if (!tbody.querySelector('tr')) {
      const empty = document.createElement('tr');
      empty.innerHTML = `<td colspan="${getColspan(tableSelector)}" class="text-center small-muted py-3">Nenhum registro pendente.</td>`;
      tbody.appendChild(empty);
    }
  }

  // Delegação de eventos para botões de ação
  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;

    // Apontar
    if (btn.classList.contains('btn-apontar')) {
      const tr = btn.closest('tr');
      const tds = tr.querySelectorAll('td');
      const payload = {
        numero_ordem: tds[1].textContent.trim(),
        codigo_peca: tds[2].textContent.trim(),
        observacao: tr.querySelector('input')?.value?.trim() || ''
      };
      const ok = await confirmarAcao('Confirmar apontamento?', `Ordem ${payload.numero_ordem} / Peça ${payload.codigo_peca}`, payload, URL_APONTAMENTOS_CONFIRMAR);
      if (ok.ok) {
        await Swal.fire({ icon: 'success', title: 'Apontado', timer: 900, showConfirmButton: false });
        removeRowAndMaybeEmpty(tr, '#table-apontamentos');
      }
    }

    // Transferir
    if (btn.classList.contains('btn-transferir')) {
      const tr = btn.closest('tr');
      const tds = tr.querySelectorAll('td');
      const payload = {
        numero_ordem: tds[1].textContent.trim(),
        observacao: tr.querySelector('input')?.value?.trim() || ''
      };
      const ok = await confirmarAcao('Confirmar transferência?', `Ordem ${payload.numero_ordem}`, payload, URL_TRANSFERENCIAS_CONFIRMAR);
      if (ok.ok) {
        await Swal.fire({ icon: 'success', title: 'Transferido', timer: 900, showConfirmButton: false });
        removeRowAndMaybeEmpty(tr, '#table-transferencias');
      }
    }
  });

  // Selecionar todos
  document.getElementById('sel-all-apontamentos').addEventListener('change', (e) => {
    document.querySelectorAll('#table-apontamentos tbody .row-select').forEach(chk => chk.checked = e.target.checked);
  });
  document.getElementById('sel-all-transferencias').addEventListener('change', (e) => {
    document.querySelectorAll('#table-transferencias tbody .row-select').forEach(chk => chk.checked = e.target.checked);
  });

  // Bulk actions
  async function bulkApontar() {
    const rows = Array.from(document.querySelectorAll('#table-apontamentos tbody tr'));
    const selecionados = rows.filter(r => r.querySelector('.row-select')?.checked);
    if (!selecionados.length) {
      await Swal.fire({ icon: 'info', title: 'Selecione ao menos um item.' });
      return;
    }
    const itens = selecionados.map(tr => ({
      numero_ordem: tr.children[1].textContent.trim(),
      codigo_peca: tr.children[2].textContent.trim(),
      observacao: tr.querySelector('input')?.value?.trim() || ''
    }));
    const ok = await confirmarAcao('Confirmar apontamento em lote?', `${itens.length} itens serão marcados.`, { itens }, URL_APONTAMENTOS_BULK);
    if (ok.ok) {
      selecionados.forEach(tr => removeRowAndMaybeEmpty(tr, '#table-apontamentos'));
      await Swal.fire({ icon: 'success', title: 'Apontamentos confirmados', timer: 1200, showConfirmButton: false });
    }
  }

  async function bulkTransferir() {
    const rows = Array.from(document.querySelectorAll('#table-transferencias tbody tr'));
    const selecionados = rows.filter(r => r.querySelector('.row-select')?.checked);
    if (!selecionados.length) {
      await Swal.fire({ icon: 'info', title: 'Selecione ao menos um item.' });
      return;
    }
    const itens = selecionados.map(tr => ({
      numero_ordem: tr.children[1].textContent.trim(),
      observacao: tr.querySelector('input')?.value?.trim() || ''
    }));
    const ok = await confirmarAcao('Confirmar transferência em lote?', `${itens.length} itens serão marcados.`, { itens }, URL_TRANSFERENCIAS_BULK);
    if (ok.ok) {
      selecionados.forEach(tr => removeRowAndMaybeEmpty(tr, '#table-transferencias'));
      await Swal.fire({ icon: 'success', title: 'Transferências confirmadas', timer: 1200, showConfirmButton: false });
    }
  }

  document.getElementById('bulk-apontar').addEventListener('click', bulkApontar);
  document.getElementById('bulk-transferir').addEventListener('click', bulkTransferir);

  // Botões refresh
  document.getElementById('refresh-apontamentos').addEventListener('click', () => {
    loadApontamentos().then(() => {
      const rows = Array.from(document.querySelectorAll('#table-apontamentos tbody tr'));
      const empty = rows.length === 1 && rows[0].querySelector('.small-muted');
      setCount('count-apontamentos', empty ? 0 : rows.length);
    });
  });
  document.getElementById('refresh-transferencias').addEventListener('click', () => {
    loadTransferencias().then(() => {
      const rows = Array.from(document.querySelectorAll('#table-transferencias tbody tr'));
      const empty = rows.length === 1 && rows[0].querySelector('.small-muted');
      setCount('count-transferencias', empty ? 0 : rows.length);
    });
  });

  // Carrega dados ao abrir as abas
  document.getElementById('tab-apontamentos-tab').addEventListener('shown.bs.tab', loadApontamentos);
  document.getElementById('tab-transferencias-tab').addEventListener('shown.bs.tab', loadTransferencias);

  // Carrega padrão
  loadApontamentos();
  // Deixa transferências carregar sob demanda
</script>
{% endblock %}
