{% extends "base.html" %}

{% load static %}

{% block title %}<title>Inspecao Corte</title>{% endblock %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/modal-inspecao-estamparia.css' %}">
<link rel="stylesheet" href="{% static 'css/inspecao.css' %}">
<link rel="stylesheet" href="{% static 'css/select2.css' %}">
{% endblock %}

{% block content %}

<h2 class="fw-bold my-4">Inspecao Corte (Apenas para plasma)</h2>

<ul class="nav nav-tabs mt-3" style="background-color: #f4f4f5;">
    <li class="nav-item" style="width: 50%;">
        <a id="tab-pendencias-corte" class="nav-link tab-active active text-center" style="font-size: 0.875rem;" onclick="activeRow('pendencias-corte','inspecionados-corte', this)">
            Pendencias
        </a>
    </li>
    <li class="nav-item" style="width: 50%;">
        <a id="tab-inspecionados-corte" class="nav-link tab-active text-center" style="font-size: 0.875rem;" onclick="activeRow('inspecionados-corte','pendencias-corte', this)">
            Inspecionados
        </a>
    </li>
</ul>

<div id="pendencias-corte" class="row mt-3">
    <div class="d-flex justify-content-between mt-3">
        <h4 style="width: 60%;">Pendencias</h4>
        <div>
            <div class="btn-group">
                <button class="btn btn-white dropdown-toggle" type="button" id="dropdownFiltroPendencias" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <form id="form-filtrar-pendencias-corte">
                    <div class="dropdown-menu p-3" style="width: 250px;">
                        <p class="fw-bold mx-2 my-1">Filtrar pendencias</p>
                        <hr>
                        <input type="text" class="form-control mb-3" id="pesquisar-ordem-pendencias" placeholder="Pesquisar ordens...">
                        <h6 class="mt-3">Periodo</h6>
                        <div class="mb-2">
                            <label for="data-inicio-pendencias" class="form-label small text-muted">Data inicial</label>
                            <input type="date" class="form-control" id="data-inicio-pendencias">
                        </div>
                        <div>
                            <label for="data-fim-pendencias" class="form-label small text-muted">Data final</label>
                            <input type="date" class="form-control" id="data-fim-pendencias">
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" id="btn-limpar-pendencias" class="btn btn-outline-secondary">Limpar</button>
                            <button type="button" id="btn-filtrar-pendencias" class="btn btn-dark">Filtrar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2 my-2">
        <span id="qtd-pendente-corte" class="rounded-pill py-1 px-2" style="background-color: #ef4444; color: #fafafa; font-weight: 600; font-size: 0.75rem;">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        </span>
        <span id="qtd-filtrada-pendencias" class="rounded-pill py-1 px-2" style="background-color: #f59e0b; color: #fafafa; font-weight: 600; font-size: 0.75rem; display: none;"></span>
    </div>

    <div class="d-flex justify-content-end flex-wrap gap-2 my-2">
        <span id="filtro-pendencias-data" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;">Data: </span>
        <span id="filtro-pendencias-pesquisa" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;">Pesquisa: </span>
    </div>

    <div class="row" style="padding-right: 0;" id="cards-pendencias-corte"></div>
    <div id="paginacao-pendencias-corte"></div>
</div>

<div id="inspecionados-corte" class="row mt-3" style="display: none;">
    <div class="d-flex justify-content-between mt-3">
        <h4 style="width: 60%;">Inspecionados</h4>
        <div>
            <div class="btn-group">
                <button class="btn btn-white dropdown-toggle" type="button" id="dropdownFiltroInspecionados" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <form id="form-filtrar-inspecionados-corte">
                    <div class="dropdown-menu p-3" style="width: 250px;">
                        <p class="fw-bold mx-2 my-1">Filtrar inspecionados</p>
                        <hr>
                        <input type="text" class="form-control mb-3" id="pesquisar-ordem-inspecionados" placeholder="Pesquisar ordens...">
                        <h6 class="mt-3">Periodo</h6>
                        <div class="mb-2">
                            <label for="data-inicio-inspecionados" class="form-label small text-muted">Data inicial</label>
                            <input type="date" class="form-control" id="data-inicio-inspecionados">
                        </div>
                        <div>
                            <label for="data-fim-inspecionados" class="form-label small text-muted">Data final</label>
                            <input type="date" class="form-control" id="data-fim-inspecionados">
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" id="btn-limpar-inspecionados" class="btn btn-outline-secondary">Limpar</button>
                            <button type="button" id="btn-filtrar-inspecionados" class="btn btn-dark">Filtrar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2 my-2">
        <span id="qtd-inspecionados-corte" class="rounded-pill py-1 px-2" style="background-color: #00940c; color: #fafafa; font-weight: 600; font-size: 0.75rem;">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        </span>
        <span id="qtd-filtrada-inspecionados" class="rounded-pill py-1 px-2" style="background-color: #f59e0b; color: #fafafa; font-weight: 600; font-size: 0.75rem; display: none;"></span>
    </div>

    <div class="d-flex justify-content-end flex-wrap gap-2 my-2">
        <span id="filtro-inspecionados-data" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;">Data: </span>
        <span id="filtro-inspecionados-pesquisa" class="rounded-pill py-1 px-2" style="background-color: #ebebeb; color: #3d3d3d; font-weight: 600; font-size: 0.75rem; display: none;">Pesquisa: </span>
    </div>

    <div class="row" style="padding-right: 0;" id="cards-inspecionados-corte"></div>
    <div id="paginacao-inspecionados-corte"></div>
</div>

<template id="template-card-pendencia-corte">
    <div class="col-sm-6 col-lg-4 mb-3">
        <div class="card p-3" style="min-height: 300px; display: flex; flex-direction: column; justify-content: space-between">
            <h5><span class='ordem-numero'></span></h5>
            <p>
                <strong>üìÖ Data do corte:</strong> <span class="ordem-data"></span><br>
                <strong>‚öôÔ∏è M√°quina:</strong> <span class="ordem-conjunto"></span><br>
                <strong>üî¢ Pe√ßas cortadas:</strong> <span class="ordem-qtd"></span><br>
            </p>
            <hr>
            <button type="button" class="btn btn-dark w-100 btn-ver-ordem" data-bs-toggle="modal" data-bs-target="#modal-ordem-corte">Ver</button>
        </div>
    </div>
</template>

<template id="template-card-inspecionado-corte">
    <div class="col-sm-6 col-lg-4 mb-3">
        <div class="card p-3" style="min-height: 300px; display: flex; flex-direction: column; justify-content: space-between">
            <h5>Pe√ßa <span class="peca"></span></h5>
            <p>Inspecao #<span class="inspecao-id"></span></p>
            <p>
                <strong>üìÖ Data:</strong> <span class="data-inspecao"></span><br>
                <strong>üî¢ Ordem:</strong> <span class="ordem-numero"></span><br>
            </p>
            <hr>
            <button type="button" class="btn btn-outline-secondary w-100 btn-ver-peca" data-peca-id="">Ver</button>
        </div>
    </div>
</template>

<div class="modal fade" id="modal-ordem-corte" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalOrdemCorteLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalOrdemCorteLabel">Inspecao corte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="accordion" id="lista-pecas-corte"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-historico-ordem-corte" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalHistoricoOrdemCorteLabel">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHistoricoOrdemCorteLabel">Hist√≥rico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="accordion" id="lista-historico-pecas-corte"></div>
            </div>
        </div>
    </div>
</div>


<template id="template-peca-corte">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse">
                <span class="peca-nome">Peca</span>
                <span class="ms-2 badge text-bg-light">Qtd: <span class="peca-qtd"></span></span>
            </button>
        </h2>
        <div class="accordion-collapse collapse">
            <div class="accordion-body">
                <form class="form-inspecao-peca-corte">
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Informacoes Basicas</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Inspetor</label>
                                    <input type="text" class="form-control" value="{% if user.get_full_name %}{{ user.get_full_name }}{% else %}{{ user.username }}{% endif %}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Data da inspecao</label>
                                    <input type="date" class="form-control data-inspecao-corte" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Peca</label>
                                    <input type="text" class="form-control peca-nome-input" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4" id="medicoesTecnicasCorte">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Medicoes Tecnicas</h6>
                        </div>
                        <div class="card-body">
                            <div id="sectionMedicaoTecCorte">
                                <div class="table-responsive">
                                    <table class="table table-bordered inspection-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th><input type="text" class="form-control" placeholder="Medida 1" style="padding: 5px;"></th>
                                            <th><input type="text" class="form-control" placeholder="Medida 2" style="padding: 5px;"></th>
                                            <th><input type="text" class="form-control" placeholder="Medida 3" style="padding: 5px;"></th>
                                            <th style="font-size: 11px;" class="text-center">Conforme</th>
                                            <th style="font-size: 11px;" class="text-center">Nao conforme</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="linha-medicao-corte" data-linha="2">
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 1" style="padding: 5px;"></td>
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 2" style="padding: 5px;"></td>
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 3" style="padding: 5px;"></td>
                                            <td class="text-center">
                                                <input class="form-check-input" type="radio" name="conformidade-1" value="conforme">
                                            </td>
                                            <td class="text-center">
                                                <input class="form-check-input" type="radio" name="conformidade-1" value="nao-conforme">
                                            </td>
                                        </tr>
                                        <tr class="linha-medicao-corte" data-linha="3">
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 1" style="padding: 5px;"></td>
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 2" style="padding: 5px;"></td>
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 3" style="padding: 5px;"></td>
                                            <td class="text-center">
                                                <input class="form-check-input" type="radio" name="conformidade-2" value="conforme">
                                            </td>
                                            <td class="text-center">
                                                <input class="form-check-input" type="radio" name="conformidade-2" value="nao-conforme">
                                            </td>
                                        </tr>
                                        <tr class="linha-medicao-corte" data-linha="4">
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 1" style="padding: 5px;"></td>
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 2" style="padding: 5px;"></td>
                                            <td><input type="number" step="0.01" class="form-control" placeholder="Valor 3" style="padding: 5px;"></td>
                                            <td class="text-center">
                                                <input class="form-check-input" type="radio" name="conformidade-3" value="conforme">
                                            </td>
                                            <td class="text-center">
                                                <input class="form-check-input" type="radio" name="conformidade-3" value="nao-conforme">
                                            </td>
                                        </tr>
                                    </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4 card-nao-conformidade-corte" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">Detalhes das Nao Conformidades</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Adicione informacoes sobre cada nao conformidade encontrada.</p>
                            <div class="container-nonconformity-items"></div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary btn-add-nonconformity">
                                    <i class="bi bi-plus-circle me-2"></i>Adicionar outra nao conformidade
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Inspecao 100%</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Necessita inspecao 100%?</label>
                                    <select class="form-select inspecao-100-select">
                                        <option value="" selected disabled></option>
                                        <option value="nao">Nao</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Anexar ficha 100%</label>
                                    <input type="file" class="form-control ficha-100-file" accept="image/*,application/pdf" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-success btn-salvar-inspecao-corte">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/corte/a-inspecionar-corte.js' %}"></script>
<script src="{% static 'js/corte/inspecionados-corte.js' %}"></script>
<script>
    function activeRow(rowVisible, rowInvisible, clickedElement) {
        document.getElementById(rowVisible).style.display = "flex";
        document.getElementById(rowInvisible).style.display = "none";

        const tabs = document.querySelectorAll(".nav-tabs .nav-link");
        tabs.forEach((tab) => tab.classList.remove("active"));
        clickedElement.classList.add("active");
    }

    let cacheCausasCorte = null;

    async function buscarCausasCorte() {
        if (cacheCausasCorte) {
            return cacheCausasCorte;
        }
        const response = await fetch("/inspecao/api/motivos-causas/corte/", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        });
        if (!response.ok) {
            throw new Error(`Erro HTTP! Status: ${response.status}`);
        }
        const dados = await response.json();
        cacheCausasCorte = dados.motivos || [];
        return cacheCausasCorte;
    }

    function criarItemNaoConformidade(index, causas) {
        const item = document.createElement("div");
        item.className = "non-conformity-item border rounded p-3 mb-3";
        item.dataset.index = index;

        const causasHtml = causas.map((causa, idx) => {
            const causaNome = causa.nome || causa.descricao || causa;
            const causaId = causa.id || `${index}_${idx + 1}`;
            return `
                <div class="form-check">
                    <input class="form-check-input causa-checkbox" type="checkbox" id="causa${index}_${idx + 1}" name="causas${index}" value="${causaId}">
                    <label class="form-check-label" for="causa${index}_${idx + 1}">${causaNome}</label>
                </div>
            `;
        }).join("");

        item.innerHTML = `
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-remove-nonconformity">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Causas da nao conformidade (selecione todas aplicaveis)</label>
                    <div class="causes-container">${causasHtml}</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Quantidade afetada</label>
                    <input type="number" class="form-control quantidade-afetada" min="1">
                    <label class="form-label mt-2">Destino</label>
                    <select class="form-select">
                        <option value="">Selecione</option>
                        <option value="sucata">Sucata</option>
                        <option value="retrabalho">Retrabalho</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Foto da nao conformidade</label>
                    <label for="fotoNaoConformidade${index}" class="custom-file-upload">
                        <i class="bi bi-camera me-2"></i>Clique para adicionar uma foto
                    </label>
                    <input type="file" id="fotoNaoConformidade${index}" accept="image/*" style="display: none;" multiple>
                    <div class="image-preview d-flex mt-2 gap-2"></div>
                </div>
            </div>
        `;

        const fileInput = item.querySelector(`#fotoNaoConformidade${index}`);
        const preview = item.querySelector(".image-preview");
        if (fileInput && preview) {
            fileInput.addEventListener("change", () => {
                preview.innerHTML = "";
                Array.from(fileInput.files || []).forEach((file) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = document.createElement("img");
                        img.src = event.target.result;
                        img.style.maxWidth = "80px";
                        img.style.maxHeight = "80px";
                        img.className = "rounded";
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        return item;
    }

    async function adicionarItemNaoConformidade(form) {
        const container = form.querySelector(".container-nonconformity-items");
        if (!container) {
            return;
        }
        const causas = await buscarCausasCorte();
        const novoIndex = container.children.length + 1;
        const item = criarItemNaoConformidade(novoIndex, causas);
        container.appendChild(item);
        atualizarLimiteQuantidade(form);
    }

    document.addEventListener("click", (event) => {
        if (event.target.closest(".btn-add-nonconformity")) {
            const form = event.target.closest(".form-inspecao-peca-corte");
            if (form) {
                adicionarItemNaoConformidade(form);
            }
        }

        if (event.target.closest(".btn-remove-nonconformity")) {
            const item = event.target.closest(".non-conformity-item");
            if (item) {
                item.remove();
                const form = event.target.closest(".form-inspecao-peca-corte");
                if (form) {
                    atualizarLimiteQuantidade(form);
                }
            }
        }
    });

    function atualizarLimiteQuantidade(form) {
        const maxPermitido = form.querySelectorAll('input[type="radio"][value="nao-conforme"]:checked').length;
        const inputs = form.querySelectorAll(".quantidade-afetada");
        let soma = 0;
        inputs.forEach((input) => {
            const valor = parseInt(input.value, 10);
            if (!Number.isNaN(valor)) {
                soma += valor;
            }
            input.max = maxPermitido || "";
            input.setCustomValidity("");
        });

        if (soma <= maxPermitido) {
            return;
        }

        const excesso = soma - maxPermitido;
        const alvo = form.querySelector(".quantidade-afetada:focus");
        if (alvo) {
            const valorAtual = parseInt(alvo.value, 10) || 0;
            const novoValor = Math.max(0, valorAtual - excesso);
            alvo.value = novoValor ? String(novoValor) : "";
            alvo.setCustomValidity("Quantidade excede o limite de nao conformes.");
            alvo.reportValidity();
        } else {
            inputs.forEach((input) => {
                if (parseInt(input.value, 10) > 0) {
                    input.setCustomValidity("Quantidade excede o limite de nao conformes.");
                    input.reportValidity();
                }
            });
        }
    }

    function atualizarVisibilidadeNaoConformidade(form) {
        const bloco = form.querySelector(".card-nao-conformidade-corte");
        if (!bloco) {
            return;
        }
        const existeNaoConforme = form.querySelector('input[type="radio"][value="nao-conforme"]:checked');
        bloco.style.display = existeNaoConforme ? "" : "none";
        if (existeNaoConforme) {
            carregarCausasNaoConformidade(form);
        }
    }

    async function carregarCausasNaoConformidade(form) {
        const container = form.querySelector(".container-nonconformity-items");
        if (!container) {
            return;
        }
        if (!container.children.length) {
            try {
                await adicionarItemNaoConformidade(form);
            } catch (error) {
                container.innerHTML = '<p class="text-danger mb-0">Erro ao carregar causas.</p>';
            }
        }
    }

    document.addEventListener("change", (event) => {
        if (event.target.matches('input[type="radio"][value="nao-conforme"], input[type="radio"][value="conforme"]')) {
            const form = event.target.closest(".form-inspecao-peca-corte");
            if (form) {
                atualizarVisibilidadeNaoConformidade(form);
                atualizarLimiteQuantidade(form);
            }
        }
    });

    document.addEventListener("input", (event) => {
        if (event.target.classList.contains("quantidade-afetada")) {
            const form = event.target.closest(".form-inspecao-peca-corte");
            if (form) {
                atualizarLimiteQuantidade(form);
            }
        }
    });

    document.addEventListener("change", (event) => {
        if (event.target.classList.contains("inspecao-100-select")) {
            const container = event.target.closest(".card-body");
            const fileInput = container.querySelector(".ficha-100-file");
            const isRequired = event.target.value === "sim";
            fileInput.disabled = !isRequired;
            fileInput.required = isRequired;
        }
    });

    document.addEventListener("show.bs.collapse", (event) => {
        const collapse = event.target;
        const dateInput = collapse.querySelector(".data-inspecao-corte");
        if (dateInput && !dateInput.value) {
            const today = new Date();
            dateInput.value = today.toISOString().slice(0, 10);
        }
        const form = collapse.querySelector(".form-inspecao-peca-corte");
        if (form) {
            const qtd = parseInt(form.dataset.qtdPeca || "0", 10);
            form.style.display = qtd > 0 ? "" : "none";
            if (qtd > 0) {
                const linhasVisiveis = qtd >= 3 ? 3 : qtd;
                const linhas = form.querySelectorAll("tbody .linha-medicao-corte");
                linhas.forEach((linha, index) => {
                    linha.style.display = index < linhasVisiveis ? "" : "none";
                });
            }
        }
    });

    function validarFormularioCorte(form) {
        const headerInputs = Array.from(form.querySelectorAll("table thead input[type=\"text\"]"));

        // Cabe√ßalhos ativos: somente os preenchidos tornam a coluna obrigat√≥ria
        const colunasAtivas = headerInputs
            .map((input, index) => (input.value.trim() ? index : -1))
            .filter((index) => index >= 0);

        // Pelo menos um cabe√ßalho precisa estar preenchido
        if (!colunasAtivas.length) {
            alert("Preencha ao menos um cabe√ßalho de Medicoes Tecnicas.");
            headerInputs[0]?.focus();
            return false;
        }

        // Linhas vis√≠veis (linhas de valores, n√£o o cabe√ßalho)
        const linhas = Array.from(form.querySelectorAll("tbody .linha-medicao-corte")).filter(
            (linha) => linha.style.display !== "none"
        );

        let linhaIndex = 0;
        for (const linha of linhas) {
            linhaIndex++;
            const valores = Array.from(linha.querySelectorAll("input[type=\"number\"]"));

            // 1) Para colunas com cabe√ßalho preenchido, valor √© obrigat√≥rio
            for (const index of colunasAtivas) {
                const input = valores[index];
                if (!input) {
                    continue;
                }
                if (input.value === "" || Number.isNaN(input.valueAsNumber)) {
                    alert("Preencha todas as medidas nas colunas com cabe√ßalho preenchido.");
                    input.focus();
                    return false;
                }
            }

            // 2) Se alguma coluna sem cabe√ßalho tiver valor, exigir o cabe√ßalho
            try {
                headerInputs.forEach((header, idx) => {
                    if (colunasAtivas.includes(idx)) {
                        return;
                    }
                    const inputValor = valores[idx];
                    if (inputValor && inputValor.value.trim()) {
                        alert("Preencha o cabe√ßalho correspondente antes de informar medidas.");
                        header.focus();
                        throw new Error("cabecalho_faltando");
                    }
                });
            } catch (e) {
                if (e.message === "cabecalho_faltando") {
                    return false;
                }
                throw e;
            }

            const radioSelecionado = linha.querySelector('input[type="radio"]:checked');
            if (!radioSelecionado) {
                alert(`Selecione Conforme ou Nao conforme na linha ${linhaIndex}.`);
                linha.querySelector('input[type="radio"]')?.focus();
                return false;
            }
        }

        const selectInspecaoTotal = form.querySelector(".inspecao-100-select");
        if (!selectInspecaoTotal || !selectInspecaoTotal.value) {
            alert("Informe se a inspecao 100% e necessaria.");
            selectInspecaoTotal?.focus();
            return false;
        }
        if (selectInspecaoTotal.value === "sim") {
            const fichaInput = form.querySelector(".ficha-100-file");
            if (!fichaInput || !fichaInput.files || !fichaInput.files.length) {
                alert("Anexe a ficha 100%.");
                fichaInput?.focus();
                return false;
            }
        }

        const existeNaoConforme = form.querySelector('input[type="radio"][value="nao-conforme"]:checked');
        if (existeNaoConforme) {
            const itens = form.querySelectorAll(".non-conformity-item");
            if (!itens.length) {
                alert("Adicione os detalhes das nao conformidades.");
                return false;
            }
            for (const item of itens) {
                const causasSelecionadas = item.querySelectorAll(".causa-checkbox:checked");
                const quantidadeInput = item.querySelector(".quantidade-afetada");
                const destinoSelect = item.querySelector("select.form-select");
                if (!causasSelecionadas.length) {
                    alert("Selecione ao menos uma causa da nao conformidade.");
                    item.querySelector(".causa-checkbox")?.focus();
                    return false;
                }
                if (!quantidadeInput || !quantidadeInput.value) {
                    alert("Informe a quantidade afetada.");
                    quantidadeInput?.focus();
                    return false;
                }
                if (!destinoSelect || !destinoSelect.value) {
                    alert("Selecione o destino.");
                    destinoSelect?.focus();
                    return false;
                }
            }
        }

        return true;
    }

    document.addEventListener("click", async (event) => {
        if (!event.target.classList.contains("btn-salvar-inspecao-corte")) {
            return;
        }
        const form = event.target.closest(".form-inspecao-peca-corte");
        if (!form) {
            return;
        }
        if (!validarFormularioCorte(form)) {
            return;
        }

        const botao = event.target;
        botao.disabled = true;
        const textoOriginal = botao.textContent;
        botao.textContent = "Salvando...";

        const formData = new FormData();
        formData.append("peca_id", form.dataset.pecaId || "");

        const selectInspecaoTotal = form.querySelector(".inspecao-100-select");
        if (selectInspecaoTotal) {
            formData.append("inspecao_total", selectInspecaoTotal.value || "");
        }
        const fichaInput = form.querySelector(".ficha-100-file");
        if (fichaInput && fichaInput.files && fichaInput.files.length) {
            formData.append("ficha", fichaInput.files[0]);
        }

        const headerInputs = form.querySelectorAll("table thead input[type=\"text\"]");
        const headerNomes = Array.from(headerInputs).map((input) => input.value || "");
        const medidas = [];
        const linhas = form.querySelectorAll("tbody .linha-medicao-corte");
        linhas.forEach((linha) => {
            if (linha.style.display === "none") {
                return;
            }
            const valores = Array.from(linha.querySelectorAll("input[type=\"number\"]"))
                .map((input) => input.value || "");
            const radioConforme = linha.querySelector("input[type=\"radio\"][value=\"conforme\"]");
            const radioNaoConforme = linha.querySelector("input[type=\"radio\"][value=\"nao-conforme\"]");
            const conforme = radioConforme ? radioConforme.checked : !radioNaoConforme?.checked;
            medidas.push({
                medida1: { nome: headerNomes[0] || "", valor: valores[0] || "" },
                medida2: { nome: headerNomes[1] || "", valor: valores[1] || "" },
                medida3: { nome: headerNomes[2] || "", valor: valores[2] || "" },
                conforme,
            });
        });
        formData.append("medicoes", JSON.stringify(medidas));

        const naoConformidades = [];
        const itens = form.querySelectorAll(".non-conformity-item");
        itens.forEach((item, index) => {
            const causas = Array.from(item.querySelectorAll(".causa-checkbox:checked")).map((checkbox) => checkbox.value);
            const quantidadeInput = item.querySelector(".quantidade-afetada");
            const destinoSelect = item.querySelector("select.form-select");
            const quantidade = quantidadeInput ? quantidadeInput.value : "";
            const destino = destinoSelect ? destinoSelect.value : "";
            naoConformidades.push({
                causas,
                quantidadeAfetada: quantidade,
                destino,
                id: index + 1,
            });

            const fileInput = item.querySelector(`input[type="file"]`);
            if (fileInput && fileInput.files && fileInput.files.length) {
                Array.from(fileInput.files).forEach((file) => {
                    formData.append(`nc_files_${index + 1}`, file);
                });
            }
        });
        formData.append("naoConformidades", JSON.stringify(naoConformidades));

        try {
            const csrfInput = document.querySelector("[name=csrfmiddlewaretoken]");
            const headers = csrfInput ? { "X-CSRFToken": csrfInput.value } : {};
            const response = await fetch("/inspecao/api/envio-inspecao-corte/", {
                method: "POST",
                headers,
                body: formData,
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || "Erro ao enviar inspecao.");
            }
            botao.textContent = "Salvo";
            setTimeout(() => {
                botao.textContent = textoOriginal;
            }, 1000);
            // Mostrar toast de sucesso
            const toastElement = document.getElementById('toast-sucesso');
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            // Remover o item inspecionado para impedir re-inspe√ß√£o
            const accordionItem = form.closest('.accordion-item');
            if (accordionItem) {
                accordionItem.remove();
            }
            // Recarregar cards de pend√™ncias ap√≥s 1.5 segundos
            setTimeout(() => {
                buscarPendencias(1);
            }, 1500);
        } catch (error) {
            console.error(error);
            alert(error.message);
            botao.textContent = textoOriginal;
        } finally {
            botao.disabled = false;
        }
    });
</script>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast-sucesso" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Sucesso</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Inspe√ß√£o salva com sucesso!
        </div>
    </div>
</div>

{% endblock %}
